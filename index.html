<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hybrid Athlete - Valutazione Performance</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;500;600;700;800;900&family=Barlow:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --gold-primary: #C9A227;
            --gold-light: #E8D48B;
            --gold-dark: #8B7015;
            --ice-blue: #7FB3D5;
            --ice-light: #A9CCE3;
            --charcoal: #1A1A1A;
            --charcoal-light: #2D2D2D;
            --charcoal-lighter: #3D3D3D;
            --bone: #F5F2E9;
            --blood-red: #8B0000;
        }
        
        * { box-sizing: border-box; }
        
        body { 
            margin: 0; 
            padding: 0; 
            font-family: 'Barlow', sans-serif;
            background: var(--charcoal);
        }
        
        .font-cinzel { font-family: 'Cinzel', serif; }
        .font-barlow { font-family: 'Barlow', sans-serif; }
        
        .norse-pattern { position: relative; }
        
        .norse-pattern::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            opacity: 0.03;
            pointer-events: none;
            background-image: 
                linear-gradient(30deg, var(--gold-primary) 1px, transparent 1px),
                linear-gradient(-30deg, var(--gold-primary) 1px, transparent 1px),
                linear-gradient(150deg, var(--gold-primary) 1px, transparent 1px),
                linear-gradient(-150deg, var(--gold-primary) 1px, transparent 1px);
            background-size: 60px 104px;
            background-position: 0 0, 30px 0, 30px -52px, 0 52px;
        }
        
        .runic-border { position: relative; }
        
        .runic-border::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 80%;
            height: 2px;
            background: linear-gradient(90deg, 
                transparent 0%, var(--gold-primary) 20%, 
                var(--gold-light) 50%, var(--gold-primary) 80%, 
                transparent 100%
            );
        }
        
        .gold-glow { text-shadow: 0 0 20px rgba(201, 162, 39, 0.3); }
        
        .carved-card {
            background: linear-gradient(145deg, #252525 0%, #1A1A1A 100%);
            box-shadow: 
                inset 0 1px 0 rgba(255,255,255,0.05),
                0 10px 40px rgba(0,0,0,0.5),
                0 0 0 1px rgba(201, 162, 39, 0.1);
        }
        
        .norse-input {
            background: rgba(0,0,0,0.4);
            border: 1px solid rgba(201, 162, 39, 0.2);
            transition: all 0.3s ease;
        }
        
        .norse-input:focus {
            border-color: var(--gold-primary);
            box-shadow: 0 0 0 3px rgba(201, 162, 39, 0.15);
            outline: none;
        }
        
        .btn-forge {
            background: linear-gradient(180deg, #D4AF37 0%, #C9A227 30%, #8B7015 100%);
            box-shadow: 
                0 4px 15px rgba(201, 162, 39, 0.4),
                inset 0 1px 0 rgba(255,255,255,0.3),
                inset 0 -2px 0 rgba(0,0,0,0.2);
            transition: all 0.3s ease;
        }
        
        .btn-forge:hover {
            transform: translateY(-2px);
            box-shadow: 
                0 6px 25px rgba(201, 162, 39, 0.5),
                inset 0 1px 0 rgba(255,255,255,0.4),
                inset 0 -2px 0 rgba(0,0,0,0.2);
        }
        
        .btn-forge:active { transform: translateY(0); }
        
        .score-ring { position: relative; }
        
        .score-ring::before {
            content: '';
            position: absolute;
            top: -8px; left: -8px; right: -8px; bottom: -8px;
            border: 2px solid var(--gold-primary);
            border-radius: 50%;
            opacity: 0.3;
        }
        
        .score-ring::after {
            content: '';
            position: absolute;
            top: -16px; left: -16px; right: -16px; bottom: -16px;
            border: 1px solid var(--gold-primary);
            border-radius: 50%;
            opacity: 0.15;
        }
        
        .badge-elite { 
            background: linear-gradient(135deg, #9B59B6 0%, #6C3483 100%);
            box-shadow: 0 2px 10px rgba(155, 89, 182, 0.4);
        }
        .badge-ottimo { 
            background: linear-gradient(135deg, var(--gold-primary) 0%, var(--gold-dark) 100%);
            box-shadow: 0 2px 10px rgba(201, 162, 39, 0.4);
        }
        .badge-buono { 
            background: linear-gradient(135deg, var(--ice-blue) 0%, #5499C7 100%);
            box-shadow: 0 2px 10px rgba(127, 179, 213, 0.4);
        }
        .badge-discreto { 
            background: linear-gradient(135deg, #A67C52 0%, #8B6914 100%);
            box-shadow: 0 2px 10px rgba(166, 124, 82, 0.4);
        }
        .badge-migliorare { 
            background: linear-gradient(135deg, #7D6B5D 0%, #5D4E42 100%);
            box-shadow: 0 2px 10px rgba(125, 107, 93, 0.3);
        }
        
        @keyframes fadeSlideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .animate-in { animation: fadeSlideUp 0.6s ease-out forwards; }
        .delay-1 { animation-delay: 0.1s; opacity: 0; }
        .delay-2 { animation-delay: 0.2s; opacity: 0; }
        .delay-3 { animation-delay: 0.3s; opacity: 0; }
        .delay-4 { animation-delay: 0.4s; opacity: 0; }
        
        .progress-forge {
            background: rgba(0,0,0,0.5);
            overflow: hidden;
        }
        
        .progress-forge-fill {
            background: linear-gradient(90deg, var(--gold-dark) 0%, var(--gold-primary) 50%, var(--gold-light) 100%);
            box-shadow: 0 0 10px rgba(201, 162, 39, 0.5);
        }
        
        .norse-divider {
            display: flex;
            align-items: center;
            gap: 1rem;
            color: var(--gold-primary);
            opacity: 0.5;
        }
        
        .norse-divider::before,
        .norse-divider::after {
            content: '';
            flex: 1;
            height: 1px;
            background: linear-gradient(90deg, transparent, var(--gold-primary), transparent);
        }
        
        /* Gap Analysis Bar */
        .gap-bar {
            position: relative;
            height: 12px;
            background: rgba(0,0,0,0.4);
            border-radius: 6px;
            overflow: visible;
        }
        
        .gap-bar-fill {
            height: 100%;
            border-radius: 6px;
            transition: width 0.8s ease-out;
        }
        
        .gap-bar-standard {
            position: absolute;
            top: -4px;
            bottom: -4px;
            width: 3px;
            background: var(--gold-primary);
            border-radius: 2px;
            box-shadow: 0 0 8px rgba(201, 162, 39, 0.6);
        }
        
        .gap-bar-standard::after {
            content: '100';
            position: absolute;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 10px;
            color: var(--gold-primary);
            font-weight: 600;
        }
        
        /* Sticky CTA */
        .sticky-cta {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(180deg, transparent 0%, rgba(26,26,26,0.95) 20%, #1A1A1A 100%);
            padding: 1rem 1rem 1.5rem;
            z-index: 100;
            transform: translateY(100%);
            transition: transform 0.4s ease-out;
        }
        
        .sticky-cta.visible {
            transform: translateY(0);
        }
        
        /* Projection card glow */
        .projection-glow {
            box-shadow: 
                0 0 30px rgba(201, 162, 39, 0.15),
                inset 0 1px 0 rgba(255,255,255,0.05);
        }
        
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--charcoal); }
        ::-webkit-scrollbar-thumb { background: var(--charcoal-lighter); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--gold-dark); }
        
        /* Hide sticky on desktop */
        @media (min-width: 768px) {
            .sticky-cta { display: none; }
            .main-content { padding-bottom: 0; }
        }
        
        @media (max-width: 767px) {
            .main-content.has-results { padding-bottom: 100px; }
        }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useRef, useEffect } = React;
        
        const AxeIcon = ({ className }) => (
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round" className={className}>
            <path d="M14 4L4 14" /><path d="M14 4L20 10" />
            <path d="M14 4C14 4 18 3 20 5C22 7 21 11 21 11" />
            <path d="M4 14L10 20" />
          </svg>
        );
        
        const ShieldIcon = ({ className }) => (
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round" className={className}>
            <path d="M12 2L3 7V12C3 17 7.5 21.5 12 22C16.5 21.5 21 17 21 12V7L12 2Z" />
            <path d="M12 6V18" /><path d="M7 9H17" />
          </svg>
        );
        
        const HelmIcon = ({ className }) => (
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round" className={className}>
            <circle cx="12" cy="12" r="9" />
            <path d="M12 3V12L18 18" /><path d="M12 12L6 18" />
            <circle cx="12" cy="12" r="3" />
          </svg>
        );
        
        const ArrowIcon = ({ className }) => (
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round" className={className}>
            <path d="M5 12H19" /><path d="M12 5L19 12L12 19" />
          </svg>
        );
        
        const DownloadIcon = ({ className }) => (
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round" className={className}>
            <path d="M21 15V19C21 20.1 20.1 21 19 21H5C3.9 21 3 20.1 3 19V15" />
            <polyline points="7 10 12 15 17 10" />
            <line x1="12" y1="15" x2="12" y2="3" />
          </svg>
        );
        
        const TrendUpIcon = ({ className }) => (
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round" className={className}>
            <polyline points="23 6 13.5 15.5 8.5 10.5 1 18" />
            <polyline points="17 6 23 6 23 12" />
          </svg>
        );

        const HybridAthleteAssessment = () => {
          const [weight, setWeight] = useState('');
          const [squat, setSquat] = useState('');
          const [run5k, setRun5k] = useState('');
          const [results, setResults] = useState(null);
          const [isCalculating, setIsCalculating] = useState(false);
          const [showStickyCta, setShowStickyCta] = useState(false);
          const canvasRef = useRef(null);
          const resultsRef = useRef(null);

          useEffect(() => {
            if (results) {
              const timer = setTimeout(() => setShowStickyCta(true), 1500);
              return () => clearTimeout(timer);
            } else {
              setShowStickyCta(false);
            }
          }, [results]);

          const standards = {
            '65-70': { name: '65-70kg', squatRatio: 2.3, run5k: 1290 },
            '70-75': { name: '70-75kg', squatRatio: 2.2, run5k: 1305 },
            '75-80': { name: '75-80kg', squatRatio: 2.1, run5k: 1335 },
            '80-85': { name: '80-85kg', squatRatio: 2.0, run5k: 1380 },
            '85-90': { name: '85-90kg', squatRatio: 1.9, run5k: 1410 },
            '90-95': { name: '90-95kg', squatRatio: 1.8, run5k: 1440 }
          };

          const getWeightCategory = (w) => {
            if (w >= 65 && w < 70) return '65-70';
            if (w >= 70 && w < 75) return '70-75';
            if (w >= 75 && w < 80) return '75-80';
            if (w >= 80 && w < 85) return '80-85';
            if (w >= 85 && w < 90) return '85-90';
            if (w >= 90 && w <= 95) return '90-95';
            return null;
          };

          const timeToSeconds = (timeStr) => {
            const parts = timeStr.split(':');
            if (parts.length === 2) return parseInt(parts[0]) * 60 + parseInt(parts[1]);
            return parseInt(timeStr);
          };

          const secondsToTime = (seconds) => {
            const mins = Math.floor(seconds / 60);
            const secs = Math.round(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
          };

          const calculateScore = (value, standard, lowerIsBetter = false) => {
            if (lowerIsBetter) return Math.round((standard / value) * 100);
            return Math.round((value / standard) * 100);
          };

          const getPerformanceLevel = (score) => {
            if (score >= 110) return { level: 'Elite', badgeClass: 'badge-elite', symbol: 'ᛟ', color: 'text-purple-400' };
            if (score >= 100) return { level: 'Ottimo', badgeClass: 'badge-ottimo', symbol: 'ᛏ', color: 'text-amber-400' };
            if (score >= 90) return { level: 'Buono', badgeClass: 'badge-buono', symbol: 'ᚱ', color: 'text-sky-400' };
            if (score >= 80) return { level: 'Discreto', badgeClass: 'badge-discreto', symbol: 'ᚹ', color: 'text-amber-600' };
            return { level: 'Da forgiare', badgeClass: 'badge-migliorare', symbol: 'ᚠ', color: 'text-stone-400' };
          };

          const getOverallPerformance = (avgScore) => {
            if (avgScore >= 110) return { text: 'ELITE WARRIOR', color: 'text-purple-400', symbol: 'ᛟ', desc: 'Superi tutti gli standard. Sei forgiato nel ferro.' };
            if (avgScore >= 100) return { text: 'FORGIATO', color: 'text-amber-400', symbol: 'ᛏ', desc: 'Raggiungi gli standard dei guerrieri.' };
            if (avgScore >= 90) return { text: 'GUERRIERO', color: 'text-sky-400', symbol: 'ᚱ', desc: 'Vicino alla perfezione. Continua a forgiare.' };
            if (avgScore >= 80) return { text: 'APPRENDISTA', color: 'text-amber-600', symbol: 'ᚹ', desc: 'Buona base. Il cammino è ancora lungo.' };
            return { text: 'INIZIATO', color: 'text-stone-400', symbol: 'ᚠ', desc: 'Il viaggio inizia qui. Forgia il tuo destino.' };
          };

          const getNextLevel = (score) => {
            if (score >= 110) return { name: 'Elite', threshold: 110 };
            if (score >= 100) return { name: 'Elite', threshold: 110 };
            if (score >= 90) return { name: 'Ottimo', threshold: 100 };
            if (score >= 80) return { name: 'Buono', threshold: 90 };
            return { name: 'Discreto', threshold: 80 };
          };

          const getRecommendedProgram = (tests) => {
            const squatTest = tests.find((t) => t.name === 'Squat' && t.completed);
            const run5kTest = tests.find((t) => t.name === '5k Run' && t.completed);

            if (!squatTest) return null;

            const squatScore = squatTest.score;
            const avgRunningScore = run5kTest?.score || 0;

            const isSquatHigh = squatScore >= 100;
            const isSquatLow = squatScore < 80;
            const isRunningHigh = avgRunningScore >= 100;
            const isRunningLow = avgRunningScore < 80 || !run5kTest;

            if (isSquatHigh && isRunningHigh) {
              return {
                name: 'PROGRAMMA D',
                title: "L'Hybrid Avanzato",
                symbol: 'ᛟ',
                gradient: 'from-stone-900 via-stone-800 to-neutral-900',
                profile: 'Lifter Avanzato + Runner Avanzato',
                description: 'Sei forte sia in sala pesi che nella corsa! Hai bisogno di periodizzazione complessa per continuare a progredire in entrambi i domini.',
                focus: [
                  'Periodizzazione avanzata con fasi alternate',
                  'Volume alto su entrambe le discipline',
                  "Gestione sofisticata dell'interferenza",
                  'Peak performance su obiettivi specifici'
                ],
                frequency: '3 Strength + 3-4 Running',
                duration: '12 settimane',
                ctaText: 'INIZIA IL PROGRAMMA D'
              };
            }

            if (isSquatHigh && isRunningLow) {
              return {
                name: 'PROGRAMMA A',
                title: 'Il Lifter che Corre',
                symbol: 'ᚦ',
                gradient: 'from-amber-950 via-stone-900 to-stone-950',
                profile: 'Lifter Avanzato + Runner Principiante',
                description: 'Sei forte in sala pesi! Ora è il momento di costruire una base aerobica solida senza perdere i tuoi guadagni di forza.',
                focus: [
                  'Mantenere/ottimizzare forza e massa muscolare',
                  'Introduzione graduale alla corsa con focus tecnico',
                  "Minimizzare interferenza tra pesi e corsa",
                  'Volume running progressivo ma conservativo'
                ],
                frequency: '3 Strength + 3 Running',
                duration: '12 settimane',
                ctaText: 'INIZIA IL PROGRAMMA A'
              };
            }

            if (isRunningHigh && isSquatLow) {
              return {
                name: 'PROGRAMMA E',
                title: 'Il Runner che Solleva',
                symbol: 'ᛖ',
                gradient: 'from-slate-900 via-stone-900 to-zinc-950',
                profile: 'Runner Avanzato + Lifter Principiante',
                description: 'Ottima base aerobica! Ora aggiungi forza per diventare un atleta più completo e prevenire infortuni.',
                focus: [
                  'Mantenere capacità aerobiche',
                  'Costruire forza fondamentale sui big lifts',
                  'Apprendimento tecnico in sala pesi',
                  'Migliorare economia di corsa con la forza'
                ],
                frequency: '3 Strength + 3-4 Running',
                duration: '12 settimane',
                ctaText: 'INIZIA IL PROGRAMMA E'
              };
            }

            if (isSquatLow && isRunningLow) {
              return {
                name: 'PROGRAMMA C',
                title: 'Il Novizio Totale',
                symbol: 'ᛉ',
                gradient: 'from-stone-900 via-neutral-900 to-stone-950',
                profile: 'Lifter Principiante + Runner Principiante',
                description: 'Stai iniziando il tuo viaggio hybrid! Focus su tecnica, consistenza e costruzione di fondamenta solide.',
                focus: [
                  'Apprendimento tecnico prioritario su tutto',
                  'Volume ridotto e focus sulla consistenza',
                  'Costruzione base di forza e resistenza',
                  'Prevenzione infortuni e movimento corretto'
                ],
                frequency: '3 Strength + 3 Running',
                duration: '12 settimane',
                ctaText: 'INIZIA IL PROGRAMMA C'
              };
            }

            return {
              name: 'PROGRAMMA B',
              title: "L'Equilibrato",
              symbol: 'ᚼ',
              gradient: 'from-zinc-900 via-stone-900 to-neutral-950',
              profile: 'Lifter Intermedio + Runner Principiante/Intermedio',
              description: 'Hai una buona base! Continua a svilupparti in modo bilanciato su entrambi i fronti.',
              focus: [
                'Sviluppo continuo della forza con volume moderato',
                'Progressione aerobica costante',
                'Educazione su entrambe le discipline',
                'Crescita bilanciata senza sacrifici'
              ],
              frequency: '3 Strength + 3 Running',
              duration: '12 settimane',
              ctaText: 'INIZIA IL PROGRAMMA B'
            };
          };

          const calculateProjectedScore = (currentScore) => {
            // Conservative 12-15% improvement estimate
            const improvementRate = currentScore < 80 ? 0.15 : currentScore < 100 ? 0.12 : 0.08;
            return Math.min(Math.round(currentScore * (1 + improvementRate)), 120);
          };

          const generateInstagramStory = async () => {
            if (!results) return;

            const canvas = canvasRef.current;
            if (!canvas) return;

            try {
              const ctx = canvas.getContext('2d');
              const width = 1080;
              const height = 1920;
              canvas.width = width;
              canvas.height = height;

              const gradient = ctx.createLinearGradient(0, 0, 0, height);
              gradient.addColorStop(0, '#1A1A1A');
              gradient.addColorStop(0.5, '#252525');
              gradient.addColorStop(1, '#1A1A1A');
              ctx.fillStyle = gradient;
              ctx.fillRect(0, 0, width, height);

              ctx.strokeStyle = 'rgba(201, 162, 39, 0.3)';
              ctx.lineWidth = 2;
              ctx.beginPath();
              ctx.moveTo(100, 280);
              ctx.lineTo(width - 100, 280);
              ctx.stroke();

              ctx.fillStyle = '#C9A227';
              ctx.font = '700 72px Cinzel, serif';
              ctx.textAlign = 'center';
              ctx.fillText('HYBRID ATHLETE', width / 2, 200);

              const status = getOverallPerformance(results.avgScore);
              ctx.font = '220px serif';
              ctx.fillStyle = '#C9A227';
              ctx.fillText(status.symbol, width / 2, 520);

              ctx.font = '600 52px Cinzel, serif';
              ctx.fillStyle = '#F5F2E9';
              ctx.fillText(status.text, width / 2, 620);

              ctx.font = '700 180px Barlow, sans-serif';
              ctx.fillStyle = '#C9A227';
              ctx.fillText(results.avgScore.toString(), width / 2, 850);

              ctx.font = '400 32px Barlow, sans-serif';
              ctx.fillStyle = '#888';
              ctx.fillText('PUNTEGGIO TOTALE', width / 2, 910);

              ctx.font = '400 36px Barlow, sans-serif';
              ctx.fillStyle = '#7FB3D5';
              ctx.fillText(`Categoria: ${results.category}`, width / 2, 990);

              ctx.strokeStyle = 'rgba(201, 162, 39, 0.2)';
              ctx.beginPath();
              ctx.moveTo(150, 1060);
              ctx.lineTo(width - 150, 1060);
              ctx.stroke();

              let yPos = 1160;
              
              results.tests.forEach((test) => {
                const perf = getPerformanceLevel(test.score);
                
                ctx.fillStyle = 'rgba(201, 162, 39, 0.08)';
                ctx.fillRect(120, yPos - 70, width - 240, 200);
                
                ctx.font = '80px serif';
                ctx.fillStyle = '#C9A227';
                ctx.textAlign = 'left';
                ctx.fillText(test.symbol, 160, yPos + 20);
                
                ctx.font = '600 44px Cinzel, serif';
                ctx.fillStyle = '#F5F2E9';
                ctx.fillText(test.name.toUpperCase(), 280, yPos - 10);
                
                ctx.font = '500 36px Barlow, sans-serif';
                ctx.fillStyle = '#AAA';
                const valueText = test.displayValue ? test.displayValue : `${test.value} ${test.unit}`;
                ctx.fillText(valueText, 280, yPos + 40);
                
                if (test.ratio) {
                  ctx.font = '400 30px Barlow, sans-serif';
                  ctx.fillStyle = '#777';
                  ctx.fillText(`${test.ratio}x BW`, 280, yPos + 85);
                }
                
                ctx.textAlign = 'right';
                ctx.font = '700 72px Barlow, sans-serif';
                ctx.fillStyle = '#C9A227';
                ctx.fillText(test.score.toString(), width - 160, yPos + 10);
                
                ctx.font = '600 28px Barlow, sans-serif';
                ctx.fillStyle = '#888';
                ctx.fillText(`${perf.symbol} ${perf.level.toUpperCase()}`, width - 160, yPos + 55);
                
                ctx.textAlign = 'center';
                yPos += 240;
              });

              ctx.strokeStyle = 'rgba(201, 162, 39, 0.2)';
              ctx.beginPath();
              ctx.moveTo(150, yPos - 20);
              ctx.lineTo(width - 150, yPos - 20);
              ctx.stroke();

              ctx.fillStyle = '#666';
              ctx.font = '400 32px Barlow, sans-serif';
              ctx.textAlign = 'center';
              ctx.fillText('nicholasrubini.it', width / 2, height - 120);

              canvas.toBlob((blob) => {
                if (!blob) return;
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = 'hybrid-athlete-results.png';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
              }, 'image/png');
            } catch (error) {
              console.error('Error:', error);
            }
          };

          const calculateResults = () => {
            const w = parseFloat(weight);

            if (!weight || !squat || !run5k) {
              alert('Completa tutti i campi obbligatori.');
              return;
            }

            const category = getWeightCategory(w);
            if (!category) {
              alert('Peso deve essere tra 65-95kg');
              return;
            }

            setIsCalculating(true);
            
            setTimeout(() => {
              const std = standards[category];
              const squatStandard = w * std.squatRatio;
              const tests = [];

              const squatValue = parseFloat(squat);
              tests.push({
                name: 'Squat',
                value: squatValue,
                standard: squatStandard,
                displayStandard: squatStandard.toFixed(1),
                ratio: (squatValue / w).toFixed(2),
                standardRatio: std.squatRatio,
                unit: 'kg',
                score: calculateScore(squatValue, squatStandard, false),
                higher: true,
                symbol: 'ᚦ',
                completed: true
              });

              const run5kSec = timeToSeconds(run5k);
              tests.push({
                name: '5k Run',
                value: run5kSec,
                standard: std.run5k,
                displayValue: run5k,
                displayStandard: secondsToTime(std.run5k),
                unit: '',
                score: calculateScore(run5kSec, std.run5k, true),
                higher: false,
                symbol: 'ᚱ',
                completed: true
              });

              const avgScore = Math.round(tests.reduce((sum, t) => sum + t.score, 0) / tests.length);

              setResults({
                category: std.name,
                tests,
                avgScore,
                completedTests: 2,
                totalPossibleTests: 2,
                recommendedProgram: getRecommendedProgram(tests),
                projectedScore: calculateProjectedScore(avgScore)
              });
              
              setIsCalculating(false);
              
              setTimeout(() => {
                resultsRef.current?.scrollIntoView({ behavior: 'smooth', block: 'start' });
              }, 100);
            }, 800);
          };

          const getGapBarColor = (score) => {
            if (score >= 100) return 'bg-gradient-to-r from-amber-600 to-amber-400';
            if (score >= 90) return 'bg-gradient-to-r from-sky-700 to-sky-500';
            if (score >= 80) return 'bg-gradient-to-r from-amber-800 to-amber-600';
            return 'bg-gradient-to-r from-stone-700 to-stone-500';
          };

          return (
            <div className="min-h-screen norse-pattern" style={{ background: 'linear-gradient(180deg, #1A1A1A 0%, #252525 50%, #1A1A1A 100%)' }}>
              <div className={`max-w-3xl mx-auto px-4 py-8 md:py-12 main-content ${results ? 'has-results' : ''}`}>
                
                {/* Header */}
                <header className="text-center mb-10 md:mb-14 runic-border pb-8">
                  <div className="flex items-center justify-center gap-3 md:gap-4 mb-4">
                    <AxeIcon className="w-8 h-8 md:w-10 md:h-10 text-amber-500" />
                    <h1 className="font-cinzel text-3xl md:text-5xl font-bold text-stone-100 tracking-wide gold-glow">
                      HYBRID ATHLETE
                    </h1>
                    <ShieldIcon className="w-8 h-8 md:w-10 md:h-10 text-amber-500" />
                  </div>
                  <p className="font-barlow text-stone-400 text-sm md:text-base tracking-widest uppercase">
                    Valutazione Performance
                  </p>
                  <p className="font-barlow text-stone-600 text-xs md:text-sm mt-3 italic">
                    Forte • Esplosivo • Veloce • Resistente
                  </p>
                </header>

                {/* Input Card */}
                <section className="carved-card rounded-lg p-6 md:p-8 mb-8">
                  <div className="flex items-center gap-3 mb-6 pb-4 border-b border-amber-900/30">
                    <HelmIcon className="w-5 h-5 md:w-6 md:h-6 text-amber-500" />
                    <h2 className="font-cinzel text-xl md:text-2xl font-semibold text-stone-100">
                      I Tuoi Dati
                    </h2>
                  </div>
                  
                  <div className="grid grid-cols-1 md:grid-cols-3 gap-5 md:gap-6">
                    <div>
                      <label className="block text-stone-400 mb-2 font-barlow text-sm font-medium tracking-wide">
                        PESO <span className="text-amber-600">*</span>
                      </label>
                      <div className="relative">
                        <input
                          type="number"
                          step="0.1"
                          value={weight}
                          onChange={(e) => setWeight(e.target.value)}
                          placeholder="75"
                          className="norse-input w-full text-stone-100 px-4 py-3.5 rounded font-barlow text-lg"
                        />
                        <span className="absolute right-4 top-1/2 -translate-y-1/2 text-stone-600 text-sm">kg</span>
                      </div>
                    </div>

                    <div>
                      <label className="block text-stone-400 mb-2 font-barlow text-sm font-medium tracking-wide">
                        SQUAT <span className="text-amber-600">*</span>
                      </label>
                      <div className="relative">
                        <input
                          type="number"
                          step="0.5"
                          value={squat}
                          onChange={(e) => setSquat(e.target.value)}
                          placeholder="140"
                          className="norse-input w-full text-stone-100 px-4 py-3.5 rounded font-barlow text-lg"
                        />
                        <span className="absolute right-4 top-1/2 -translate-y-1/2 text-stone-600 text-sm">kg</span>
                      </div>
                    </div>

                    <div>
                      <label className="block text-stone-400 mb-2 font-barlow text-sm font-medium tracking-wide">
                        5K RUN <span className="text-amber-600">*</span>
                      </label>
                      <input
                        type="text"
                        value={run5k}
                        onChange={(e) => setRun5k(e.target.value)}
                        placeholder="22:30"
                        className="norse-input w-full text-stone-100 px-4 py-3.5 rounded font-barlow text-lg"
                      />
                    </div>
                  </div>

                  <button
                    onClick={calculateResults}
                    disabled={isCalculating}
                    className="btn-forge w-full mt-8 text-stone-900 font-cinzel font-bold py-4 md:py-5 rounded text-base md:text-lg tracking-wide disabled:opacity-50"
                  >
                    {isCalculating ? 'FORGIANDO...' : 'FORGIA LA TUA VALUTAZIONE'}
                  </button>
                </section>

                {/* Results */}
                {results && (
                  <div ref={resultsRef} className="space-y-6 animate-in">
                    
                    {/* Main Score */}
                    <section className="carved-card rounded-lg p-6 md:p-10 text-center delay-1 animate-in">
                      <div className="mb-6">
                        <span className="text-6xl md:text-8xl text-amber-500 font-light" style={{ fontFamily: 'serif' }}>
                          {getOverallPerformance(results.avgScore).symbol}
                        </span>
                      </div>
                      
                      <h3 className={`font-cinzel text-2xl md:text-4xl font-bold mb-2 ${getOverallPerformance(results.avgScore).color}`}>
                        {getOverallPerformance(results.avgScore).text}
                      </h3>
                      
                      <p className="font-barlow text-stone-500 text-sm md:text-base mb-6">
                        {getOverallPerformance(results.avgScore).desc}
                      </p>
                      
                      <div className="inline-flex items-center gap-6 md:gap-10">
                        <div className="score-ring w-28 h-28 md:w-36 md:h-36 rounded-full flex flex-col items-center justify-center" style={{ background: 'rgba(201, 162, 39, 0.1)' }}>
                          <span className="font-barlow text-4xl md:text-5xl font-bold text-amber-400">{results.avgScore}</span>
                          <span className="font-barlow text-stone-500 text-xs tracking-wider">SCORE</span>
                        </div>
                        <div className="text-left">
                          <p className="font-barlow text-stone-400 text-sm">Categoria</p>
                          <p className="font-cinzel text-stone-200 text-lg md:text-xl font-semibold">{results.category}</p>
                          <p className="font-barlow text-sky-400 text-sm mt-2">{results.completedTests}/{results.totalPossibleTests} Test</p>
                        </div>
                      </div>
                    </section>

                    {/* GAP ANALYSIS - NEW */}
                    <section className="carved-card rounded-lg p-6 md:p-8 delay-2 animate-in">
                      <h3 className="font-cinzel text-lg md:text-xl font-semibold text-stone-100 mb-6 flex items-center gap-2">
                        <span className="text-amber-500">ᛗ</span> Analisi del Gap
                      </h3>
                      
                      <div className="space-y-6">
                        {results.tests.map((test, idx) => {
                          const perf = getPerformanceLevel(test.score);
                          const gap = 100 - test.score;
                          const barWidth = Math.min(test.score, 120);
                          
                          return (
                            <div key={idx}>
                              <div className="flex justify-between items-center mb-2">
                                <div className="flex items-center gap-2">
                                  <span className="text-xl text-amber-500/80" style={{ fontFamily: 'serif' }}>{test.symbol}</span>
                                  <span className="font-cinzel text-stone-200 font-medium">{test.name}</span>
                                </div>
                                <div className="flex items-center gap-3">
                                  <span className={`font-barlow text-2xl font-bold ${perf.color}`}>{test.score}</span>
                                  {gap > 0 && (
                                    <span className="font-barlow text-xs text-stone-500 bg-stone-800 px-2 py-1 rounded">
                                      -{gap} dallo standard
                                    </span>
                                  )}
                                  {gap <= 0 && (
                                    <span className="font-barlow text-xs text-amber-400 bg-amber-900/30 px-2 py-1 rounded">
                                      +{Math.abs(gap)} sopra!
                                    </span>
                                  )}
                                </div>
                              </div>
                              
                              <div className="gap-bar">
                                <div 
                                  className={`gap-bar-fill ${getGapBarColor(test.score)}`}
                                  style={{ width: `${barWidth}%` }}
                                />
                                <div className="gap-bar-standard" style={{ left: 'calc(100% * 100 / 120 - 1.5px)' }} />
                              </div>
                              
                              <div className="flex justify-between mt-2 font-barlow text-xs text-stone-500">
                                <span>{test.displayValue || test.value} {test.unit}</span>
                                <span>Standard: {test.displayStandard} {test.unit}</span>
                              </div>
                            </div>
                          );
                        })}
                      </div>
                    </section>

                    {/* PROJECTION - NEW */}
                    <section className="carved-card rounded-lg p-6 md:p-8 delay-2 animate-in projection-glow border border-amber-900/30">
                      <div className="flex items-start gap-4">
                        <div className="p-3 bg-amber-900/30 rounded-lg">
                          <TrendUpIcon className="w-6 h-6 text-amber-400" />
                        </div>
                        <div className="flex-1">
                          <h3 className="font-cinzel text-lg md:text-xl font-semibold text-stone-100 mb-2">
                            Dove potresti arrivare
                          </h3>
                          <p className="font-barlow text-stone-400 text-sm mb-4">
                            Con il programma giusto, in 12 settimane:
                          </p>
                          
                          <div className="flex items-center gap-4 mb-4">
                            <div className="text-center">
                              <span className="font-barlow text-stone-500 text-xs block mb-1">OGGI</span>
                              <span className="font-barlow text-2xl font-bold text-stone-400">{results.avgScore}</span>
                            </div>
                            <div className="flex-1 h-px bg-gradient-to-r from-stone-600 via-amber-500 to-amber-400 relative">
                              <ArrowIcon className="w-5 h-5 text-amber-400 absolute right-0 top-1/2 -translate-y-1/2 translate-x-1/2" />
                            </div>
                            <div className="text-center">
                              <span className="font-barlow text-amber-400 text-xs block mb-1">12 SETTIMANE</span>
                              <span className="font-barlow text-3xl font-bold text-amber-400">{results.projectedScore}</span>
                            </div>
                          </div>
                          
                          <p className="font-barlow text-stone-500 text-xs">
                            {results.avgScore < 100 
                              ? `Solo ${100 - results.avgScore} punti ti separano dallo standard. Con costanza e il metodo giusto, è assolutamente raggiungibile.`
                              : 'Sei già sopra lo standard! Il programma ti aiuterà a consolidare e raggiungere il livello Elite.'
                            }
                          </p>
                        </div>
                      </div>
                    </section>

                    {/* Recommended Program */}
                    {results.recommendedProgram && (
                      <section className={`rounded-lg p-6 md:p-8 delay-2 animate-in bg-gradient-to-br ${results.recommendedProgram.gradient} border border-amber-900/20`}>
                        <div className="text-center mb-6">
                          <span className="text-5xl md:text-6xl text-amber-400/80" style={{ fontFamily: 'serif' }}>
                            {results.recommendedProgram.symbol}
                          </span>
                          <h3 className="font-cinzel text-xl md:text-2xl font-bold text-stone-100 mt-3">
                            {results.recommendedProgram.name}
                          </h3>
                          <p className="font-barlow text-amber-400/90 text-sm font-medium">
                            {results.recommendedProgram.title}
                          </p>
                        </div>

                        <div className="bg-black/20 rounded p-4 md:p-5 mb-5">
                          <p className="font-barlow text-stone-300 text-center text-sm md:text-base leading-relaxed">
                            {results.recommendedProgram.description}
                          </p>
                        </div>

                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                          <div className="bg-black/20 rounded p-4">
                            <h4 className="font-cinzel text-amber-400/90 font-semibold mb-3 text-sm">Focus</h4>
                            <ul className="space-y-2">
                              {results.recommendedProgram.focus.map((item, idx) => (
                                <li key={idx} className="font-barlow text-stone-400 text-xs md:text-sm flex items-start gap-2">
                                  <span className="text-amber-500 mt-0.5">•</span>
                                  <span>{item}</span>
                                </li>
                              ))}
                            </ul>
                          </div>
                          <div className="bg-black/20 rounded p-4">
                            <h4 className="font-cinzel text-amber-400/90 font-semibold mb-3 text-sm">Struttura</h4>
                            <div className="space-y-3">
                              <div>
                                <p className="font-barlow text-stone-500 text-xs">Frequenza</p>
                                <p className="font-barlow text-stone-200 font-semibold">{results.recommendedProgram.frequency}</p>
                              </div>
                              <div>
                                <p className="font-barlow text-stone-500 text-xs">Durata</p>
                                <p className="font-barlow text-stone-200 font-semibold">{results.recommendedProgram.duration}</p>
                              </div>
                            </div>
                          </div>
                        </div>

                        {/* CTA PERSONALIZZATO */}
                        <div className="text-center">
                          <a
                            href="https://www.nicholasrubini.it/prodotto/scheda-hybrid-athlete/"
                            target="_blank"
                            rel="noopener noreferrer"
                            className="btn-forge inline-flex items-center gap-2 text-stone-900 font-cinzel font-bold px-6 md:px-8 py-3.5 md:py-4 rounded text-sm md:text-base"
                          >
                            {results.recommendedProgram.ctaText}
                            <ArrowIcon className="w-4 h-4 md:w-5 md:h-5" />
                          </a>
                          <p className="font-barlow text-stone-500 text-xs mt-3">
                            Il programma selezionato in base ai tuoi risultati
                          </p>
                        </div>
                      </section>
                    )}

                    {/* Individual Tests */}
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4 delay-3 animate-in">
                      {results.tests.map((test, idx) => {
                        const perf = getPerformanceLevel(test.score);
                        return (
                          <div key={idx} className="carved-card rounded-lg p-5 md:p-6">
                            <div className="flex items-start justify-between mb-4">
                              <div className="flex items-center gap-3">
                                <span className="text-2xl md:text-3xl text-amber-500/80" style={{ fontFamily: 'serif' }}>{test.symbol}</span>
                                <div>
                                  <h4 className="font-cinzel font-semibold text-stone-100">{test.name}</h4>
                                  <span className={`inline-block px-2 py-0.5 rounded text-xs font-barlow font-medium text-white mt-1 ${perf.badgeClass}`}>
                                    {perf.symbol} {perf.level}
                                  </span>
                                </div>
                              </div>
                              <div className="text-right">
                                <span className="font-barlow text-2xl md:text-3xl font-bold text-stone-100">{test.score}</span>
                              </div>
                            </div>
                            
                            <div className="space-y-2 text-sm font-barlow">
                              <div className="flex justify-between">
                                <span className="text-stone-500">Il tuo valore</span>
                                <span className="text-stone-200 font-semibold">
                                  {test.displayValue || test.value} {test.unit}
                                </span>
                              </div>
                              <div className="flex justify-between">
                                <span className="text-stone-500">Standard</span>
                                <span className="text-stone-400">
                                  {test.higher ? '>' : '<'} {test.displayStandard || test.standard} {test.unit}
                                </span>
                              </div>
                              {test.ratio && (
                                <div className="flex justify-between pt-2 border-t border-stone-800">
                                  <span className="text-stone-500">Rapporto</span>
                                  <span className="text-amber-400 font-medium">
                                    {test.ratio}x <span className="text-stone-600">vs {test.standardRatio}x</span>
                                  </span>
                                </div>
                              )}
                            </div>
                            
                            <div className="mt-4 progress-forge rounded-full h-2">
                              <div
                                className="progress-forge-fill h-full rounded-full transition-all duration-700"
                                style={{ width: `${Math.min(test.score, 120)}%` }}
                              />
                            </div>
                          </div>
                        );
                      })}
                    </div>

                    {/* Share Section */}
                    <section className="carved-card rounded-lg p-5 md:p-6 text-center delay-4 animate-in border border-amber-900/20">
                      <p className="font-cinzel text-stone-300 mb-4 text-sm md:text-base">Condividi i tuoi risultati</p>
                      <button
                        onClick={generateInstagramStory}
                        className="inline-flex items-center gap-2 bg-stone-800 hover:bg-stone-700 text-stone-200 font-barlow font-medium px-5 py-3 rounded transition-all text-sm"
                      >
                        <DownloadIcon className="w-4 h-4" />
                        SCARICA IMMAGINE
                      </button>
                    </section>

                    {/* Score Legend */}
                    <section className="text-center py-6 delay-4 animate-in">
                      <div className="norse-divider text-xs mb-4">
                        <span className="font-cinzel tracking-wider">LEGENDA</span>
                      </div>
                      <div className="flex flex-wrap justify-center gap-3 md:gap-4 font-barlow text-xs">
                        <span className="text-purple-400">ᛟ Elite ≥110</span>
                        <span className="text-amber-400">ᛏ Ottimo 100+</span>
                        <span className="text-sky-400">ᚱ Buono 90+</span>
                        <span className="text-amber-600">ᚹ Discreto 80+</span>
                        <span className="text-stone-500">ᚠ Da forgiare &lt;80</span>
                      </div>
                    </section>
                  </div>
                )}

                <canvas ref={canvasRef} style={{ display: 'none' }} />

                {/* Footer */}
                <footer className="mt-12 pt-6 border-t border-stone-800/50 text-center">
                  <p className="font-barlow text-stone-600 text-xs tracking-wider">
                    nicholasrubini.it • Vichinghi Hybrid Training
                  </p>
                </footer>
              </div>

              {/* STICKY CTA MOBILE - NEW */}
              {results && results.recommendedProgram && (
                <div className={`sticky-cta ${showStickyCta ? 'visible' : ''}`}>
                  <a
                    href="https://www.nicholasrubini.it/prodotto/scheda-hybrid-athlete/"
                    target="_blank"
                    rel="noopener noreferrer"
                    className="btn-forge w-full flex items-center justify-center gap-2 text-stone-900 font-cinzel font-bold py-4 rounded text-sm"
                  >
                    {results.recommendedProgram.ctaText}
                    <ArrowIcon className="w-4 h-4" />
                  </a>
                </div>
              )}
            </div>
          );
        };

        const container = document.getElementById('root');
        const root = ReactDOM.createRoot(container);
        root.render(<HybridAthleteAssessment />);
    </script>
</body>
</html>
